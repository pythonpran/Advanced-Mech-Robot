#!/usr/bin/env python

import qwiic_icm20948
import time
import sys
import math

def runExample():
    print("\nSparkFun 9DoF ICM-20948 Sensor Example with Magnetometer Calibration\n")
    IMU = qwiic_icm20948.QwiicIcm20948()

    if IMU.connected == False:
        print("The Qwiic ICM20948 device isn't connected to the system. Please check your connection", file=sys.stderr)
        return

    IMU.begin()
    time.sleep(1)

    # --- Calibration phase ---
    print("Rotate the sensor slowly in all directions for 15 seconds to calibrate magnetometer...")
    mag_x_min = mag_y_min = mag_z_min = float('inf')
    mag_x_max = mag_y_max = mag_z_max = float('-inf')

    start_time = time.time()
    while time.time() - start_time < 15:
        if IMU.dataReady():
            IMU.getAgmt()  # update all axes

            # Update min/max for calibration
            mag_x_min = min(mag_x_min, IMU.mxRaw)
            mag_y_min = min(mag_y_min, IMU.myRaw)
            mag_z_min = min(mag_z_min, IMU.mzRaw)

            mag_x_max = max(mag_x_max, IMU.mxRaw)
            mag_y_max = max(mag_y_max, IMU.myRaw)
            mag_z_max = max(mag_z_max, IMU.mzRaw)
        time.sleep(0.05)

    # Compute offsets
    offset_x = (mag_x_max + mag_x_min) / 2
    offset_y = (mag_y_max + mag_y_min) / 2
    offset_z = (mag_z_max + mag_z_min) / 2

    print("\nCalibration complete.")
    print(f"Offsets -> X: {offset_x:.2f}, Y: {offset_y:.2f}, Z: {offset_z:.2f}\n")

    # --- Main loop ---
    print("Reading calibrated magnetometer and heading... (Ctrl+C to stop)\n")
    while True:
        if IMU.dataReady():
            IMU.getAgmt()

            # Apply offsets
            mag_x = IMU.mxRaw - offset_x
            mag_y = IMU.myRaw - offset_y
            mag_z = IMU.mzRaw - offset_z

            # Compute heading (2D compass)
            heading = math.degrees(math.atan2(mag_y, mag_x))
            if heading < 0:
                heading += 360

            print(
                f"mx: {mag_x:6.0f}\tmy: {mag_y:6.0f}\tmz: {mag_z:6.0f}\tHeading: {heading:.1f}Â°"
            )
        else:
            print("Waiting for data...")
        time.sleep(0.2)

if __name__ == '__main__':
    try:
        runExample()
    except (KeyboardInterrupt, SystemExit) as exErr:
        print("\nEnding Example")
        sys.exit(0)
